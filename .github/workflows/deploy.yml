name: Deploy React (Vite) to Cloud Run

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Total job timeout (45 minutes)

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCLOUD_PROJECT_ID }}
          export_default_credentials: true

      - name: Prepare production env for Vite
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" > .env.production
          echo ".env.production created."

      - name: Build & Push Docker Image (Cloud Build -> Artifact Registry)
        env:
          PROJECT_ID: ${{ secrets.GCLOUD_PROJECT_ID }}
        run: |
          IMAGE="us-central1-docker.pkg.dev/${PROJECT_ID}/react-repo/react-frontend:${GITHUB_SHA}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          echo "Building and pushing Docker image: $IMAGE"
          echo "Project ID: ${PROJECT_ID}"
          echo "Commit SHA: ${GITHUB_SHA}"
          
          # Submit build asynchronously to avoid log streaming issues
          echo "Submitting Docker build..."
          # Use --tag flag to ensure image is tagged with the commit SHA
          BUILD_OUTPUT=$(gcloud builds submit --tag "$IMAGE" . --async 2>&1) || true
          
          # Verify the tag format is correct
          echo "Image tag format: ${GITHUB_SHA}"
          echo "Full image path: $IMAGE"
          
          echo "Build submission output:"
          echo "$BUILD_OUTPUT"
          
          # Extract build ID from output - try multiple methods
          # Method 1: Extract from URL pattern "builds/BUILD_ID" or "builds/BUILD_ID]"
          BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oE 'builds/[a-f0-9-]+' | head -1 | cut -d'/' -f2 | tr -d ']')
          
          # Method 2: Extract UUID pattern directly
          if [ -z "$BUILD_ID" ]; then
            BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oE '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -1 | tr -d ']')
          fi
          
          # Method 3: Try to get from recent builds list
          if [ -z "$BUILD_ID" ]; then
            echo "WARNING: Could not extract build ID from output, trying to find from recent builds..."
            sleep 10
            BUILD_ID=$(gcloud builds list --limit=1 --format="value(id)" --filter="source.repoSource.commitSha:${GITHUB_SHA}" 2>/dev/null || echo "")
          fi
          
          # Clean build ID - remove any trailing brackets or special characters
          BUILD_ID=$(echo "$BUILD_ID" | tr -d '[]' | xargs)
          
          if [ -z "$BUILD_ID" ]; then
            echo "ERROR: Could not determine build ID. Build may have failed to start."
            echo "Full build output:"
            echo "$BUILD_OUTPUT"
            exit 1
          fi
          
          echo "Build submitted with ID: $BUILD_ID"
          echo "Build URL: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=${PROJECT_ID}"
          echo "Waiting for build to complete (will check image in registry instead of build status)..."
          
          # Instead of polling build status (which may have permission issues),
          # wait for the image to appear in the registry
          # This is more reliable and doesn't require build status permissions
          
          # Wait for image to appear in registry (this is more reliable than polling build status)
          echo "Waiting for image to appear in Artifact Registry..."
          echo "This may take a few minutes while the build completes..."
          echo "You can check build progress at: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=${PROJECT_ID}"
          
          MAX_WAIT=1800  # 30 minutes max
          ELAPSED=0
          INTERVAL=10
          IMAGE_FOUND=false
          LAST_BUILD_CHECK=0
          BUILD_CHECK_INTERVAL=60  # Check build status every 60 seconds
          BUILD_STATUS="UNKNOWN"  # Initialize build status
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Periodically check build status to catch failures early
            if [ $((ELAPSED - LAST_BUILD_CHECK)) -ge $BUILD_CHECK_INTERVAL ]; then
              echo "Checking build status..."
              BUILD_STATUS=$(gcloud builds describe "$BUILD_ID" --format="value(status)" 2>/dev/null || echo "UNKNOWN")
              
              if [ "$BUILD_STATUS" = "FAILURE" ] || [ "$BUILD_STATUS" = "CANCELLED" ] || [ "$BUILD_STATUS" = "EXPIRED" ]; then
                echo "ERROR: Build failed with status: $BUILD_STATUS"
                echo "Build URL: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=${PROJECT_ID}"
                echo "Please check the build logs in the GCP Console for details."
                exit 1
              elif [ "$BUILD_STATUS" = "SUCCESS" ]; then
                echo "Build completed successfully! Waiting for image to appear in registry..."
              elif [ "$BUILD_STATUS" != "UNKNOWN" ]; then
                echo "Build status: $BUILD_STATUS (still running...)"
              fi
              
              LAST_BUILD_CHECK=$ELAPSED
            fi
            
            # Check for image - start checking after 2 minutes or if build succeeded
            if [ "$BUILD_STATUS" = "SUCCESS" ] || [ "$ELAPSED" -gt 120 ]; then
              # Try multiple methods to verify image exists
              # Method 1: Check by tag (if tag was applied)
              IMAGE_BY_TAG=$(gcloud artifacts docker images list \
                us-central1-docker.pkg.dev/${PROJECT_ID}/react-repo/react-frontend \
                --filter="tags:${GITHUB_SHA}" \
                --format="value(package)" 2>/dev/null | head -1 || echo "")
              
              # Method 2: Try to describe the image directly by full path
              IMAGE_EXISTS=$(gcloud artifacts docker images describe \
                "$IMAGE" \
                --format="value(name)" 2>/dev/null || echo "")
              
              # Method 3: Check most recent image (by creation time) - might be our build
              if [ -z "$IMAGE_EXISTS" ] && [ -z "$IMAGE_BY_TAG" ]; then
                LATEST_IMAGE=$(gcloud artifacts docker images list \
                  us-central1-docker.pkg.dev/${PROJECT_ID}/react-repo/react-frontend \
                  --sort-by=~CREATE_TIME \
                  --limit=1 \
                  --format="value(package)" 2>/dev/null | head -1 || echo "")
                
                # If we have a latest image and build just succeeded, assume it's ours
                if [ -n "$LATEST_IMAGE" ] && [ "$BUILD_STATUS" = "SUCCESS" ] && [ "$ELAPSED" -lt 300 ]; then
                  echo "Build succeeded recently, assuming latest image is the new build..."
                  IMAGE_EXISTS="found"
                fi
              fi
              
              if [ -n "$IMAGE_EXISTS" ] || [ -n "$IMAGE_BY_TAG" ]; then
                echo "✓ Image found in registry!"
                echo "Verifying image is fully available (waiting 15 seconds for propagation)..."
                sleep 15
                
                # Final verification - try to describe the image
                FINAL_CHECK=$(gcloud artifacts docker images describe \
                  "$IMAGE" \
                  --format="value(name)" 2>/dev/null || echo "")
                
                if [ -n "$FINAL_CHECK" ]; then
                  echo "✓ Image verified and ready for deployment!"
                  IMAGE_FOUND=true
                  break
                else
                  echo "Warning: Image not accessible by full path, but may still be available. Continuing..."
                  # If build succeeded and we've waited a bit, assume it's ready
                  if [ "$BUILD_STATUS" = "SUCCESS" ] && [ "$ELAPSED" -gt 180 ]; then
                    echo "Build succeeded and waited 3+ minutes, proceeding with deployment..."
                    IMAGE_FOUND=true
                    break
                  fi
                fi
              fi
            fi
            
            # Show progress every 30 seconds, and warn when approaching timeout
            if [ $((ELAPSED % 30)) -eq 0 ] && [ $ELAPSED -gt 0 ]; then
              REMAINING=$((MAX_WAIT - ELAPSED))
              if [ $REMAINING -lt 300 ]; then
                echo "⚠️ WARNING: Only ${REMAINING}s remaining before timeout!"
              fi
              echo "Still waiting for image... (${ELAPSED}s elapsed, checking every 10s)"
            fi
            
            # Check if we've exceeded the timeout
            if [ $ELAPSED -ge $MAX_WAIT ]; then
              echo "ERROR: Timeout reached (${MAX_WAIT}s). Exiting..."
              break
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          if [ "$IMAGE_FOUND" != "true" ]; then
            echo "WARNING: Image not found by tag after ${ELAPSED} seconds"
            echo "Expected image: $IMAGE"
            echo "Build ID: $BUILD_ID"
            echo "Build URL: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=${PROJECT_ID}"
            echo ""
            echo "Checking final build status..."
            FINAL_STATUS=$(gcloud builds describe "$BUILD_ID" --format="value(status)" 2>/dev/null || echo "UNKNOWN")
            echo "Final build status: $FINAL_STATUS"
            
            if [ "$FINAL_STATUS" = "SUCCESS" ]; then
              echo ""
              echo "Build succeeded! Images exist in registry (may not have tags yet)."
              echo "Proceeding with deployment - Cloud Run should be able to resolve the image."
              echo ""
              echo "Note: Image tags may take a few moments to appear, but the image exists."
              # Don't exit - proceed with deployment
              # The image exists, Cloud Run should be able to use it
            else
              echo ""
              echo "Listing recent images in registry:"
              gcloud artifacts docker images list \
                us-central1-docker.pkg.dev/${PROJECT_ID}/react-repo/react-frontend \
                --limit=10 \
                --format="table(package,version,tags,create_time)" || true
              echo ""
              echo "ERROR: Build did not succeed. Cannot proceed with deployment."
              exit 1
            fi
          fi
          
          echo "Image verification completed in ${ELAPSED} seconds"

      - name: Final Image Verification
        env:
          PROJECT_ID: ${{ secrets.GCLOUD_PROJECT_ID }}
        run: |
          echo "Performing final verification that image exists before deployment..."
          echo "Looking for image with tag: ${GITHUB_SHA}"
          
          # Try multiple verification methods
          IMAGE_VERIFY=$(gcloud artifacts docker images list \
            us-central1-docker.pkg.dev/${PROJECT_ID}/react-repo/react-frontend \
            --format="value(tags)" 2>/dev/null | grep "${GITHUB_SHA}" || echo "")
          
          # Also try with filter
          if [ -z "$IMAGE_VERIFY" ]; then
            IMAGE_VERIFY=$(gcloud artifacts docker images list \
              us-central1-docker.pkg.dev/${PROJECT_ID}/react-repo/react-frontend \
              --filter="tags:${GITHUB_SHA}" \
              --format="value(package)" 2>/dev/null | head -1 || echo "")
          fi
          
          if [ -z "$IMAGE_VERIFY" ]; then
            echo "ERROR: Image verification failed! Image not found in registry."
            echo "Expected image: $IMAGE"
            echo "Expected tag: ${GITHUB_SHA}"
            echo ""
            echo "This should not happen - the previous step should have caught this."
            echo "Listing all available images in registry:"
            gcloud artifacts docker images list \
              us-central1-docker.pkg.dev/${PROJECT_ID}/react-repo/react-frontend \
              --limit=20 \
              --format="table(package,version,tags,create_time)" || true
            echo ""
            echo "Checking if repository exists:"
            gcloud artifacts repositories describe react-repo \
              --location=us-central1 \
              --format="value(name)" || echo "Repository check failed"
            exit 1
          fi
          
          echo "✓ Final verification passed - image exists and is ready for deployment"
          echo "Found image with tag: ${GITHUB_SHA}"

      - name: Deploy to Cloud Run
        env:
          REGION: ${{ secrets.REGION }}
        run: |
          echo "Deploying to Cloud Run..."
          echo "Deploying image: $IMAGE"
          
          # Deploy with explicit image verification
          gcloud run deploy react-frontend \
            --image="$IMAGE" \
            --region="${REGION}" \
            --platform=managed \
            --allow-unauthenticated \
            --quiet
          
          echo "Deployment completed successfully!"

      - name: Show Cloud Run URL
        env:
          REGION: ${{ secrets.REGION }}
        run: |
          echo "Service URL:"
          gcloud run services describe react-frontend \
            --region="${REGION}" \
            --format='value(status.url)'
