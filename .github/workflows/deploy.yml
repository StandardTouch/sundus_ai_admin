name: Deploy React (Vite) to Cloud Run

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Total job timeout (45 minutes)

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCLOUD_PROJECT_ID }}
          export_default_credentials: true

      - name: Prepare production env for Vite
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" > .env.production
          echo ".env.production created."

      - name: Build & Push Docker Image (Cloud Build -> Artifact Registry)
        env:
          PROJECT_ID: ${{ secrets.GCLOUD_PROJECT_ID }}
        run: |
          IMAGE="us-central1-docker.pkg.dev/${PROJECT_ID}/react-repo/react-frontend:${GITHUB_SHA}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          echo "Building and pushing Docker image: $IMAGE"
          echo "Project ID: ${PROJECT_ID}"
          echo "Commit SHA: ${GITHUB_SHA}"
          
          # Submit build asynchronously and get build ID
          echo "Submitting Docker build..."
          BUILD_OUTPUT=$(gcloud builds submit --tag "$IMAGE" . --async 2>&1) || true
          
          echo "Build submission output:"
          echo "$BUILD_OUTPUT"
          
          # Extract build ID from output
          BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oE 'builds/[a-f0-9-]+' | head -1 | cut -d'/' -f2 | tr -d ']' | xargs)
          
          # Fallback: try UUID pattern
          if [ -z "$BUILD_ID" ]; then
            BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oE '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -1 | tr -d ']' | xargs)
          fi
          
          if [ -z "$BUILD_ID" ]; then
            echo "ERROR: Could not extract build ID from output"
            echo "Full build output:"
            echo "$BUILD_OUTPUT"
            exit 1
          fi
          
          echo "Build submitted with ID: $BUILD_ID"
          echo "Build URL: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=${PROJECT_ID}"
          echo "Waiting for build to complete..."
          
          # Wait for build to complete - poll build status
          MAX_WAIT=1800  # 30 minutes max
          ELAPSED=0
          INTERVAL=15  # Check every 15 seconds
          BUILD_STATUS=""
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            BUILD_STATUS=$(gcloud builds describe "$BUILD_ID" --format="value(status)" 2>/dev/null || echo "UNKNOWN")
            
            if [ "$BUILD_STATUS" = "SUCCESS" ]; then
              echo "✓ Build completed successfully!"
              break
            elif [ "$BUILD_STATUS" = "FAILURE" ] || [ "$BUILD_STATUS" = "CANCELLED" ] || [ "$BUILD_STATUS" = "EXPIRED" ]; then
              echo "ERROR: Build failed with status: $BUILD_STATUS"
              echo "Build URL: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=${PROJECT_ID}"
              echo "Please check the build logs in the GCP Console for details."
              exit 1
            elif [ "$BUILD_STATUS" != "UNKNOWN" ] && [ -n "$BUILD_STATUS" ]; then
              # Show status every 60 seconds
              if [ $((ELAPSED % 60)) -eq 0 ] && [ $ELAPSED -gt 0 ]; then
                echo "Build status: $BUILD_STATUS (${ELAPSED}s elapsed)"
              fi
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          if [ "$BUILD_STATUS" != "SUCCESS" ]; then
            echo "ERROR: Build did not complete successfully within ${MAX_WAIT} seconds"
            echo "Final build status: ${BUILD_STATUS:-UNKNOWN}"
            echo "Build URL: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=${PROJECT_ID}"
            exit 1
          fi
          
          echo "Build completed in ${ELAPSED} seconds"
          echo "Waiting 10 seconds for image to be fully available..."
          sleep 10

      - name: Verify Image Ready
        env:
          PROJECT_ID: ${{ secrets.GCLOUD_PROJECT_ID }}
        run: |
          echo "Verifying image is ready for deployment..."
          echo "Image: $IMAGE"
          
          # Since build completed successfully, the image should exist
          # Cloud Run can resolve images even if tags aren't immediately visible in Artifact Registry
          # Just verify that images exist in the repository
          IMAGE_COUNT=$(gcloud artifacts docker images list \
            us-central1-docker.pkg.dev/${PROJECT_ID}/react-repo/react-frontend \
            --limit=1 \
            --format="value(package)" 2>/dev/null | wc -l || echo "0")
          
          if [ "$IMAGE_COUNT" -gt 0 ]; then
            echo "✓ Images exist in registry"
            echo "Proceeding with deployment..."
          else
            echo "WARNING: No images found in registry, but build succeeded."
            echo "This may be a temporary issue. Proceeding with deployment anyway."
            echo "Cloud Run will attempt to resolve the image."
          fi

      - name: Deploy to Cloud Run
        env:
          REGION: ${{ secrets.REGION }}
        run: |
          echo "Deploying to Cloud Run..."
          echo "Deploying image: $IMAGE"
          
          # Deploy with explicit image verification
          gcloud run deploy react-frontend \
            --image="$IMAGE" \
            --region="${REGION}" \
            --platform=managed \
            --allow-unauthenticated \
            --quiet
          
          echo "Deployment completed successfully!"

      - name: Show Cloud Run URL
        env:
          REGION: ${{ secrets.REGION }}
        run: |
          echo "Service URL:"
          gcloud run services describe react-frontend \
            --region="${REGION}" \
            --format='value(status.url)'
