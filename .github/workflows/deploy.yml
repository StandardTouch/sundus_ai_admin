name: Deploy React (Vite) to Cloud Run

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCLOUD_PROJECT_ID }}
          export_default_credentials: true

      - name: Prepare production env for Vite
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" > .env.production
          echo ".env.production created."

      - name: Build & Push Docker Image (Cloud Build -> Artifact Registry)
        env:
          PROJECT_ID: ${{ secrets.GCLOUD_PROJECT_ID }}
        run: |
          IMAGE="us-central1-docker.pkg.dev/${PROJECT_ID}/react-repo/react-frontend:${GITHUB_SHA}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          echo "Building and pushing Docker image: $IMAGE"
          echo "Project ID: ${PROJECT_ID}"
          echo "Commit SHA: ${GITHUB_SHA}"
          
          # Submit build asynchronously to avoid log streaming issues
          echo "Submitting Docker build..."
          BUILD_OUTPUT=$(gcloud builds submit --tag "$IMAGE" . --async 2>&1) || true
          
          echo "Build submission output:"
          echo "$BUILD_OUTPUT"
          
          # Extract build ID from output - try multiple methods
          # Method 1: Extract from URL pattern "builds/BUILD_ID" or "builds/BUILD_ID]"
          BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oE 'builds/[a-f0-9-]+' | head -1 | cut -d'/' -f2 | tr -d ']')
          
          # Method 2: Extract UUID pattern directly
          if [ -z "$BUILD_ID" ]; then
            BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oE '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -1 | tr -d ']')
          fi
          
          # Method 3: Try to get from recent builds list
          if [ -z "$BUILD_ID" ]; then
            echo "WARNING: Could not extract build ID from output, trying to find from recent builds..."
            sleep 10
            BUILD_ID=$(gcloud builds list --limit=1 --format="value(id)" --filter="source.repoSource.commitSha:${GITHUB_SHA}" 2>/dev/null || echo "")
          fi
          
          # Clean build ID - remove any trailing brackets or special characters
          BUILD_ID=$(echo "$BUILD_ID" | tr -d '[]' | xargs)
          
          if [ -z "$BUILD_ID" ]; then
            echo "ERROR: Could not determine build ID. Build may have failed to start."
            echo "Full build output:"
            echo "$BUILD_OUTPUT"
            exit 1
          fi
          
          echo "Build submitted with ID: $BUILD_ID"
          echo "Build URL: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=${PROJECT_ID}"
          echo "Waiting for build to complete (will check image in registry instead of build status)..."
          
          # Instead of polling build status (which may have permission issues),
          # wait for the image to appear in the registry
          # This is more reliable and doesn't require build status permissions
          
          # Wait for image to appear in registry (this is more reliable than polling build status)
          echo "Waiting for image to appear in Artifact Registry..."
          echo "This may take a few minutes while the build completes..."
          
          MAX_WAIT=1800  # 30 minutes max
          ELAPSED=0
          INTERVAL=10
          IMAGE_FOUND=false
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Check if image exists
            IMAGE_LIST=$(gcloud artifacts docker images list \
              us-central1-docker.pkg.dev/${PROJECT_ID}/react-repo/react-frontend \
              --filter="tags:${GITHUB_SHA}" \
              --format="value(tags)" 2>/dev/null || echo "")
            
            if echo "$IMAGE_LIST" | grep -q "${GITHUB_SHA}"; then
              echo "âœ“ Image found in registry!"
              IMAGE_FOUND=true
              break
            fi
            
            # Show progress every 30 seconds
            if [ $((ELAPSED % 30)) -eq 0 ] && [ $ELAPSED -gt 0 ]; then
              echo "Still waiting for image... (${ELAPSED}s elapsed, checking every 10s)"
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          if [ "$IMAGE_FOUND" != "true" ]; then
            echo "ERROR: Image not found in registry after ${MAX_WAIT} seconds!"
            echo "Expected image: $IMAGE"
            echo "Build ID: $BUILD_ID"
            echo "Build URL: https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=${PROJECT_ID}"
            echo ""
            echo "Listing recent images in registry:"
            gcloud artifacts docker images list \
              us-central1-docker.pkg.dev/${PROJECT_ID}/react-repo/react-frontend \
              --limit=10 \
              --format="table(package,version,tags)" || true
            exit 1
          fi
          
          echo "Image verification completed in ${ELAPSED} seconds"

      - name: Deploy to Cloud Run
        env:
          REGION: ${{ secrets.REGION }}
        run: |
          echo "Deploying to Cloud Run..."
          gcloud run deploy react-frontend \
            --image="$IMAGE" \
            --region="${REGION}" \
            --platform=managed \
            --allow-unauthenticated
          echo "Deployment completed."

      - name: Show Cloud Run URL
        env:
          REGION: ${{ secrets.REGION }}
        run: |
          echo "Service URL:"
          gcloud run services describe react-frontend \
            --region="${REGION}" \
            --format='value(status.url)'
